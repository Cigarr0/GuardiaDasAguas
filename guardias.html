<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Como nascem as guardiÃ£s - Jogo</title>
    <link rel="stylesheet" href="style.css">
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <div vw class="enabled"><div vw-access-button class="active"></div><div vw-plugin-wrapper></div></div>
    <header>
        <nav class="nav-container">
            <div class="logo">GuardiÃ£s</div>
            <ul class="nav-menu">
                <li><a href="index.html">InÃ­cio</a></li>
                <li><a href="guardias.html" class="active special-link">Jogar: Como nascem as guardiÃ£s</a></li>
                <div class="accessibility-tools">
                    <button id="read-page" class="acc-btn">ðŸ”Š Ouvir</button>
                    <button id="theme-toggle" class="dark-mode-toggle">ðŸŒ™</button>
                </div>
            </ul>
        </nav>
    </header>
    <main>
        <section class="hero-brand reveal">
            <h1 class="main-title">Como nascem as guardiÃ£s</h1>
            <h2 class="sub-title">Explore e proteja o nosso minimundo</h2>
        </section>
        <section class="container reveal" style="padding-top: 0;">
            <div id="game-canvas-container" style="position: relative; width: 100%; height: 60vh; overflow: hidden; border-radius: 12px; background-color: #000;">
                <div id="game-loading-overlay" class="game-loading-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: white; z-index: 10;">
                    <button id="btn-comecar" style="padding: 15px 30px; font-size: 18px; cursor: pointer; border-radius: 8px; background-color: #4a148c; color: white; border: none; font-weight: bold; transition: 0.3s;">ComeÃ§ar ExperiÃªncia</button>
                </div>
            </div>
        </section>
    </main>
    <script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
    <script src="script.js"></script>
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        const container = document.getElementById('game-canvas-container');
        const btnComecar = document.getElementById('btn-comecar');
        btnComecar.addEventListener('click', () => {
            document.getElementById('game-loading-overlay').style.display = 'none';
            iniciarJogo();
        });
        function iniciarJogo() {
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            const camera = new THREE.PerspectiveCamera(10, container.clientWidth / container.clientHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            scene.add(new THREE.AmbientLight(0xffffff, 1.2));
            const sun = new THREE.DirectionalLight(0xffffff, 1.0);
            sun.position.set(5, 10, 5);
            scene.add(sun);
            const raycaster = new THREE.Raycaster();
            let mapaMeshes = [];
            let mapaCarregado = false;
            const loader = new GLTFLoader();
            loader.load('Modelos/mapa.glb', (gltf) => {
                scene.add(gltf.scene);
                gltf.scene.traverse(child => { if (child.isMesh) mapaMeshes.push(child); });
                mapaCarregado = true;
            });
            let jogador, mixer, currentAction = 'Idle';
            const animationsMap = new Map();
            const keysPressed = {};
            loader.load('Modelos/Player.gltf', (gltf) => {
                jogador = gltf.scene;
                jogador.scale.set(0.15, 0.15, 0.15);
                scene.add(jogador);
                mixer = new THREE.AnimationMixer(jogador);
                gltf.animations.forEach(clip => {
                    const name = clip.name.toLowerCase();
                    const action = mixer.clipAction(clip);
                    if (name.includes('idle')) animationsMap.set('Idle', action);
                    else if (name.includes('run')) animationsMap.set('Run', action);
                    else if (name.includes('walk')) animationsMap.set('Walk', action);
                });
                animationsMap.get('Idle')?.play();
            });
            window.addEventListener('keydown', (e) => keysPressed[e.key.toLowerCase()] = true);
            window.addEventListener('keyup', (e) => keysPressed[e.key.toLowerCase()] = false);
            const clock = new THREE.Clock();
            const upVec = new THREE.Vector3(0, 1, 0);
            function update() {
                requestAnimationFrame(update);
                const delta = clock.getDelta();
                if (!jogador || !mapaCarregado) return;
                const directionPressed = ['w', 'a', 's', 'd'].some(k => keysPressed[k]);
                const isRunning = keysPressed['shift'];
                let play = directionPressed ? (isRunning ? 'Run' : 'Walk') : 'Idle';
                if (currentAction !== play) {
                    animationsMap.get(currentAction)?.fadeOut(0.2);
                    animationsMap.get(play)?.reset().fadeIn(0.2).play();
                    currentAction = play;
                }
                mixer.update(delta);
                let moveX = 0;
                let moveZ = 0;
                if (keysPressed['w']) moveZ -= 1;
                if (keysPressed['s']) moveZ += 1;
                if (keysPressed['a']) moveX -= 1;
                if (keysPressed['d']) moveX += 1;
                if (directionPressed) {
                    const moveDir = new THREE.Vector3(moveX, 0, moveZ).normalize();
                    const vel = isRunning ? 4.5 : 2.0;
                    const nextPos = jogador.position.clone().addScaledVector(moveDir, vel * delta);
                    raycaster.set(new THREE.Vector3(nextPos.x, 10, nextPos.z), new THREE.Vector3(0, -1, 0));
                    const intersects = raycaster.intersectObjects(mapaMeshes, true);
                    if (intersects.length > 0) {
                        jogador.position.copy(nextPos);
                        jogador.position.y = intersects[0].point.y;
                        const normal = intersects[0].face.normal.clone().applyQuaternion(intersects[0].object.quaternion);
                        const targetQuat = new THREE.Quaternion().setFromUnitVectors(upVec, normal);
                        const angle = Math.atan2(moveDir.x, moveDir.z);
                        const rotationQuat = new THREE.Quaternion().setFromAxisAngle(upVec, angle);
                        jogador.quaternion.slerp(targetQuat.multiply(rotationQuat), 0.15);
                    }
                }
                const camOffset = new THREE.Vector3(0, 4.5, 16); 
                camera.position.lerp(jogador.position.clone().add(camOffset), 0.1);
                camera.lookAt(jogador.position.x, jogador.position.y + 0.8, jogador.position.z);
                renderer.render(scene, camera);
            }
            update();
        }
    </script>
</body>
</html>